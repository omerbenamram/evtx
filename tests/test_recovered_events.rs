mod fixtures;
use evtx::{EvtxParser, ParserSettings};
use fixtures::*;


#[test]
fn test_empty_page() {
    ensure_env_logger_initialized();
    let evtx_file = include_bytes!("../samples/Microsoft-Windows-WorkFolders%4WHC.evtx");

    let settings = ParserSettings::default()
      .parse_empty_chunks(true);

    let mut parser = EvtxParser::from_buffer(evtx_file.to_vec())
      .unwrap()
      .with_configuration(settings);

    let mut record_vec = vec![];
    let mut count = 0;
    for r in parser.records() {
        record_vec.push(r.unwrap());
        count += 1;
    }

    assert_eq!(
r###"<?xml version="1.0" encoding="utf-8"?>
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
  <System>
    <Provider Name="Microsoft-Windows-Kernel-WHEA" Guid="7B563579-53C8-44E7-8236-0F87B9FE6594">
    </Provider>
    <EventID>5</EventID>
    <Version>0</Version>
    <Level>4</Level>
    <Task>0</Task>
    <Opcode>0</Opcode>
    <Keywords>0x2000000000000000</Keywords>
    <TimeCreated SystemTime="2018-05-04 18:19:22.005908 UTC">
    </TimeCreated>
    <EventRecordID>2</EventRecordID>
    <Correlation>
    </Correlation>
    <Execution ProcessID="4" ThreadID="8">
    </Execution>
    <Channel>Microsoft-Windows-Kernel-WHEA/Operational</Channel>
    <Computer>win10-test</Computer>
    <Security UserID="S-1-5-18">
    </Security>
  </System>
  <EventData>
    <Data Name="ErrorSourceCount">4</Data>
    <Data Name="ErrorRecordFormat">10</Data>
    <Data Name="ErrorSourceTableLength">4256</Data>
    <Data Name="ErrorSourceTable">D0CB5ADB0C9FFFFFC85538EF03F8FFFF000000000000008000000000080000002807000057686561000000000000000000905ADB0C9FFFFF000000000000000004000000580100000000000000000000000000000000000000CC0300000A000000000000000200000041010000080000000400000000000000000000800000000000000106000000000000000000000000FFFFFFFFFFFFFFFF0001000000040000010400000204000003040000FFFFFFFFFFFFFFFF0101000004040000050400000604000007040000FFFFFFFFFFFFFFFF0201000008040000090400000A0400000B040000FFFFFFFFFFFFFFFF030100000C0400000D0400000E0400000F040000FFFFFFFFFFFFFFFF0401000010040000110400001204000013040000FFFFFFFFFFFFFFFF0501000014040000150400001604000017040000FFFFFFFFFFFFFFFF0601000018040000190400001A0400001B040000FFFFFFFFFFFFFFFF070100001C0400001D0400001E0400001F040000FFFFFFFFFFFFFFFF0801000020040000210400002204000023040000FFFFFFFFFFFFFFFF0901000024040000250400002604000027040000FFFFFFFFFFFFFFFF0A01000028040000290400002A0400002B040000FFFFFFFFFFFFFFFF0B0100002C0400002D0400002E0400002F040000FFFFFFFFFFFFFFFF0C01000030040000310400003204000033040000FFFFFFFFFFFFFFFF0D01000034040000350400003604000037040000FFFFFFFFFFFFFFFF0E01000038040000390400003A0400003B040000FFFFFFFFFFFFFFFF0F0100003C0400003D0400003E0400003F040000FFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D00B5BDB0C9FFFFFD0AB04DD0C9FFFFF000000000000008000000000080000002807000057686561010000000000000000D05ADB0C9FFFFF000000000000000004000000580100000000000000000000000000000000000000CC0300000A00000001000000020000004101000008000000040000000100000000000080000000000100010600000000001C000060EA000000000000000000000000000000000000000000000001000000040000010400000204000003040000FFFFFFFFFFFFFFFF0101000004040000050400000604000007040000FFFFFFFFFFFFFFFF0201000008040000090400000A0400000B040000FFFFFFFFFFFFFFFF030100000C0400000D0400000E0400000F040000FFFFFFFFFFFFFFFF0401000010040000110400001204000013040000FFFFFFFFFFFFFFFF0501000014040000150400001604000017040000FFFFFFFFFFFFFFFF0601000018040000190400001A0400001B040000FFFFFFFFFFFFFFFF070100001C0400001D0400001E0400001F040000FFFFFFFFFFFFFFFF0801000020040000210400002204000023040000FFFFFFFFFFFFFFFF0901000024040000250400002604000027040000FFFFFFFFFFFFFFFF0A01000028040000290400002A0400002B040000FFFFFFFFFFFFFFFF0B0100002C0400002D0400002E0400002F040000FFFFFFFFFFFFFFFF0C01000030040000310400003204000033040000FFFFFFFFFFFFFFFF0D01000034040000350400003604000037040000FFFFFFFFFFFFFFFF0E01000038040000390400003A0400003B040000FFFFFFFFFFFFFFFF0F0100003C0400003D0400003E0400003F040000FFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D08B04DD0C9FFFFFD0CB5ADB0C9FFFFF00000000000000800000000001000000C0060000576865610300000000000000409904DD0C9FFFFF000000000000000003000000C00100000000000000000000000000000000000000CC0300000A00000003000000020000000001000001000000030000000200000000000080000000000200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C85538EF03F8FFFFD00B5BDB0C9FFFFF00000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001CC0300000A00000007000000020000000004000001000000010000000300000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</Data>
  </EventData>
</Event>"###,
        record_vec[0].data,
        "Unexpected value!"
    );

    assert_eq!(count, 2, "Recovery of records in empty page failed");
}
